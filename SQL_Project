# Question 1
SELECT
  format_date("%Y%m", parse_date("%Y%m%d", date)) as month,
  SUM(totals.visits) AS visits,
  SUM(totals.pageviews) AS pageviews,
  SUM(totals.transactions) AS transactions,

FROM `bigquery-public-data.google_analytics_sample.ga_sessions_2017*`

WHERE _TABLE_SUFFIX BETWEEN '0101' AND '0331'
GROUP BY 1
ORDER BY 1;

# Question 2 
SELECT trafficSource.source
   ,count(totals.visits) total_visits
   ,count(totals.bounces) total_no_of_bounces
  , ROUND((count(totals.bounces)*100/count(totals.visits)),3) AS bounce_rate

FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`

GROUP BY trafficSource.source
ORDER BY total_visits DESC

# Question 3
SELECT *

FROM (
    SELECT 'Month' AS time_type
           ,FORMAT_DATE('%Y%m', PARSE_DATE('%Y%m%d', date)) time
           ,trafficSource.source
           ,ROUND(SUM(productRevenue)/1000000,4) AS revenue
FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201706*`,
UNNEST (hits) hits,
UNNEST (hits.product) product
WHERE productRevenue IS NOT NULL 
GROUP BY source, time

UNION ALL 

SELECT 'Week' AS time_type,
    FORMAT_DATE('%Y%U', PARSE_DATE('%Y%m%d', date)) time
    ,trafficSource.source
    ,ROUND(SUM(productRevenue)/1000000,4) revenue
 FROM `bigquery-public-data.google_analytics_sample.ga_sessions_201706*`,
 UNNEST (hits) hits,
 UNNEST (hits.product) product
WHERE productRevenue IS NOT NULL 
GROUP BY source, time
)
ORDER BY source, time_type, time 

#Question 4 
with 
purchaser_data as(
  select
      format_date("%Y%m",parse_date("%Y%m%d",date)) as month,
      (sum(totals.pageviews)/count(distinct fullvisitorid)) as avg_pageviews_purchase,
  from `bigquery-public-data.google_analytics_sample.ga_sessions_2017*`
    ,unnest(hits) hits
    ,unnest(product) product
  where _table_suffix between '0601' and '0731'
  and totals.transactions>=1
  and product.productRevenue is not null
  group by month
),

non_purchaser_data as(
  select
      format_date("%Y%m",parse_date("%Y%m%d",date)) as month,
      sum(totals.pageviews)/count(distinct fullvisitorid) as avg_pageviews_non_purchase,
  from `bigquery-public-data.google_analytics_sample.ga_sessions_2017*`
      ,unnest(hits) hits
    ,unnest(product) product
  where _table_suffix between '0601' and '0731'
  and totals.transactions is null
  and product.productRevenue is null
  group by month
)

select
    pd.*,
    avg_pageviews_non_purchase
FROM purchaser_data pd
FULL JOIN non_purchaser_data USING(month)
order by pd.month;

#Question 5 
Select
    format_date("%Y%m",parse_date("%Y%m%d",date)) as month,
    sum(totals.transactions)/count(distinct fullvisitorid) as Avg_total_transactions_per_user
from `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`
    ,unnest (hits) hits,
    unnest(product) product
where  totals.transactions>=1
and product.productRevenue is not null
group by month;

#Question 6 
select
    format_date("%Y%m",parse_date("%Y%m%d",date)) as month,
    ((sum(product.productRevenue)/sum(totals.visits))/power(10,6)) as avg_revenue_by_user_per_visit
from `bigquery-public-data.google_analytics_sample.ga_sessions_201707*`
  ,unnest(hits) hits
  ,unnest(product) product
where product.productRevenue is not null
and totals.transactions>=1
group by month;

#Question 7 
